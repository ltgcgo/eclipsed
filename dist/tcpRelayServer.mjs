"use strict";let se=Object.defineProperty;let ie=(e,t,n)=>t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;let E=(e,t,n)=>(ie(e,typeof t!="symbol"?t+"":t,n),n),D=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};let w=(e,t,n)=>(D(e,t,"read from private field"),n?n.call(e):t.get(e)),v=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},N=(e,t,n,s)=>(D(e,t,"write to private field"),s?s.call(e,n):t.set(e,n),n);let W=(e,t,n)=>(D(e,t,"access private method"),n);let G=["utf-8","utf-16","utf-16be"],R,L,I,oe=(R=class extends EventTarget{constructor(t,n=0){super();v(this,L,void 0);v(this,I,void 0);if(n?.constructor!=Number||n<0||n>=G.length)throw new TypeError("Invalid split mode");if(n)throw new Error("UTF-16LE/BE currently not implemented");if(!t||t?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");N(this,L,t);let s=t.getReader();N(this,I,new TextDecoder(G[n],{fatal:!0}));let i=!0,r=!0,o;(async()=>{for(s.closed.then(()=>{o&&(this.dispatchEvent(new MessageEvent("raw",{data:o})),o=void 0),this.dispatchEvent(new Event("close")),r=!1}).catch(c=>{o&&(this.dispatchEvent(new MessageEvent("raw",{data:o})),o=void 0),this.dispatchEvent(new ErrorEvent("error",{message:c.message,error:c})),this.dispatchEvent(new Event("close")),r=!1});i&&r;)try{let c=await s.read();if(i=!c.done,i){let l=c.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:l})),l.constructor!=Uint8Array&&l.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:l}));else{let a=0,y=0,F=0,T=!1;for(let u=0;u<l.length;u++){switch(l[u]){case 10:{F==13?a++:(T=!0,y=u);break}case 13:{T=!0,y=u;break}default:T=!1}if(T){let f=l.subarray(a,y),k=f;o&&(k=new Uint8Array(o.length+f.length),k.set(o),k.set(f,o.length),o=void 0),this.dispatchEvent(new MessageEvent("raw",{data:k}));try{let ne=w(this,I).decode(k);this.dispatchEvent(new MessageEvent("text",{data:ne}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:k}))}a=u+1,T=!1}F=l[u]}if(!T)if(o){let u=l.subarray(a),f=new Uint8Array(o.length+u.length);f.set(o),f.set(u,o.length),o=f}else a<l.length&&(o=l.subarray(a))}}else o&&(this.dispatchEvent(new MessageEvent("raw",{data:o})),o=void 0),this.dispatchEvent(new Event("close"))}catch(c){o&&(this.dispatchEvent(new MessageEvent("raw",{data:o})),o=void 0),this.dispatchEvent(new ErrorEvent("error",{message:c.message,error:c})),this.dispatchEvent(new Event("close"))}})()}},L=new WeakMap,I=new WeakMap,E(R,"SPLIT_UTF_8",0),E(R,"SPLIT_UTF_16_LE",1),E(R,"SPLIT_UTF_16_BE",2),R),V=oe;let re=class extends EventTarget{static sleep(e){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(e).addEventListener("abort",t):setTimeout(t,e)})}#t;#n;#e=!1;get finished(){return this.#e}finish(){this.#e=!0,this.#n&&this.#n()}wait(){if(!this.#e)return this.#t}constructor(){super(),this.#t=new Promise(e=>{this.#n=()=>{this.#e=!0,e()}})}},C=re;let ae="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_",z=new Uint8Array(1),J=e=>{let t="";for(;e>0;)crypto.getRandomValues(z),t+=ae[Math.floor(z[0]&63)],e--;return t},d=()=>!!self.debugMode,O=e=>e.replaceAll("\r",`
`).replaceAll(`\r
`,`
`).split(`
`);let A={Server:"Eclipsed","Content-Type":"text/plain","Cache-Control":"no-cache, no-store","Access-Control-Allow-Methods":"GET, POST, PUT, PATCH, OPTIONS","Access-Control-Allow-Origin":"*"},$={Server:"Eclipsed","Content-Type":"text/event-stream","Cache-Control":"no-cache, no-store",Vary:"Authorization, If-Match, Last-Event-ID","Access-Control-Allow-Headers":"Authorization, Accept, Cache-Control, If-Match, Last-Event-ID","Access-Control-Allow-Methods":"GET, POST, PUT, PATCH, OPTIONS","Access-Control-Allow-Origin":"*"},le=2500;let Y=Symbol("closedSocket"),m=new TextEncoder,X=m.encode("data: "),K=m.encode(`

`),ce=(e,t)=>{for(let n=0;n<e.length;n++){let s=e.charCodeAt(n);if(s<32&&(s!=10&&s!=13||!t||s!=9))throw new RangeError("Control characters are not allowed")}},j=class extends EventTarget{#t;#n=[];#e=[];#s;#u=!1;#c=0;#i=0;#a=0;#l=0;#d=!1;#h=1;#g=0;CLOSED=0;OPEN=3;TX_OPEN=1;RX_OPEN=2;PROBING=1;TRUE=2;FALSE=0;#o=!1;shutdownTimeout=15e3;#r(){let e=this;e.#n.length>e.#a?e.dispatchEvent(new Event("newrx")):e.#n.length<e.#a&&e.dispatchEvent(new Event("deadrx")),e.#e.length>e.#l?e.dispatchEvent(new Event("newtx")):e.#e.length<e.#l&&e.dispatchEvent(new Event("deadtx"));let t=0;if(e.#e.length&&(t|=1),e.#n.length&&(t|=2),t!=e.#i){switch(d()&&console.debug(`[Eclipsed] Old state: ${e.#i}`),d()&&console.debug(`[Eclipsed] New state: ${t}`),t){case 0:{switch(d()&&console.debug(`[Eclipsed] Close all: ${e.#s}`),e.dispatchEvent(new Event("close")),e.#i){case 1:{e.dispatchEvent(new Event("closetx"));break}case 2:{e.dispatchEvent(new Event("closerx"));break}case 3:{e.dispatchEvent(new Event("dangle")),e.dispatchEvent(new Event("closetx")),e.dispatchEvent(new Event("closerx"));break}}break}case 3:{d()&&console.debug(`[Eclipsed] Connect duplex: ${e.#s}`),e.dispatchEvent(new Event("connect"));break}case 1:{switch(e.#i){case 0:{e.dispatchEvent(new Event("connecttx"));break}case 3:{e.dispatchEvent(new Event("closerx")),d()&&console.debug(`[Eclipsed] No duplex: ${e.#s}`),e.dispatchEvent(new Event("dangle"));break}}break}case 2:{switch(e.#i){case 0:{e.dispatchEvent(new Event("connectrx"));break}case 3:{e.dispatchEvent(new Event("closetx")),e.dispatchEvent(new Event("dangle"));break}}break}}e.#i=t}e.#a=e.#n.length,e.#l=e.#e.length}get id(){return this.#s}get readyState(){return this.#i}getRequest(){let e=this;if(e.#n.length)return e.#n[0]}getResponse(){let e=this;if(e.#e.length)return e.#e[0]}sendEvent(e="message"){if(this.#o)throw new Error("Tried to send data through a closed socket");ce(e),this.getResponse()[1].enqueue(m.encode(`event: ${e}
`))}sendData(e){if(this.#o)throw new Error("Tried to send data through a closed socket");O(e).forEach(t=>{this.getResponse()[1].enqueue(m.encode(`data: ${t}
`))})}sendDataRaw(e){let t=this;if(t.#o)throw new Error("Tried to send data through a closed socket");if(!e?.BYTES_PER_ELEMENT||e.BYTES_PER_ELEMENT!=1)throw new TypeError("Only Uint8Array is accepted");let n=0,s=!1;for(let i=0;i<e.length;i++){let r=e[i];switch(r){case 10:case 13:s||(t.getResponse()[1].enqueue(X),t.getResponse()[1].enqueue(e.subarray(n,i)),t.getResponse()[1].enqueue(K),s=!0),n=i+1;default:r<32&&(e[i]=32),s=!1}}s||(t.getResponse()[1].enqueue(X),t.getResponse()[1].enqueue(e.subarray(n)),t.getResponse()[1].enqueue(K))}sendComment(e){if(this.#o)throw new Error("Tried to send data through a closed socket");O(e).forEach(t=>{this.getResponse()[1].enqueue(m.encode(`:${t}
`))})}sendFlush(){if(this.#o)throw new Error("Tried to send data through a closed socket");let e=this;e.#d?e.getResponse()[1].enqueue(m.encode(`
`)):e.getResponse()[1].enqueue(m.encode(`id: ${e.#s}.${e.#c}

`)),e.#c++}send(e,t){let n=this;t&&n.sendEvent(t),n.sendData(e),n.sendFlush()}useCustomExt(e){this.#d=e}close(){let e=this;for(d()&&console.debug(`[Eclipsed] Closing down the socket: ${e.#s}...`);e.#n.length>0;)e.#n[0].cancel(),e.#n.splice(0,1);for(;e.#e.length>0;)e.#e[0][1].close(),e.#e.splice(0,1);e.#r()}attachRequest(e){let t=this;this.#n.push(e),t.#r(),t.useCustomExt(!0);let n=new C,s=new V(e.body,0,"utf-8"),i,r="";return s.addEventListener("text",({data:o})=>{console.debug(o);let c=o?.indexOf(":");if(!o?.trim()?.length)r&&(t.dispatchEvent(new MessageEvent(i||"message",{data:r})),i=void 0,r="");else if(o.codePointAt(0)==58)o.indexOf("eclipsed:")==1&&t.dispatchEvent(new MessageEvent("eclipsedext",{data:o.slice(10)}));else if(c>-1){let l=o.slice(0,c),a=c+1;o.codePointAt(c+1)==32&&a++;let y=o.slice(a);switch(l){case"event":{i=y;break}case"data":{r.length&&(r+=`
`),r+=y;break}default:}}}),s.addEventListener("close",()=>{n.finish();let o=t.#n.indexOf(e);o>=0&&t.#n.splice(o,1),t.#r()}),n.wait()}async newResponse(){let e=this,t,n=!0,s=new C,i,r=new ReadableStream({start:l=>{i=l,s.finish()},cancel:l=>{if(s.finished){let a=e.#e.indexOf(t);a>=0&&e.#e.splice(a,1),e.#r()}else n=!1}}),o=structuredClone($);o.ETag=e.#s;let c=new Response(r,{status:200,headers:o});return await s.wait(),t=[c,i],n&&(e.#e.push(t),e.#r()),c}constructor(e,t,n){super();let s=this;if(!e)throw new Error("Invalid event socket root");if(!t)throw new Error("Invalid socket ID");s.#t=e,s.#s=t,s.#u=!!n,s.addEventListener("connecttx",()=>{s.sendComment("eclipsed:new")}),s.addEventListener("close",async()=>{await C.sleep(Math.max(1e4,s.shutdownTimeout)),s.#i==0&&(s.#o=!0,d()&&console.debug(`[Eclipsed] Socket ${s.#s} shutdown`),s.dispatchEvent(new Event("shutdown")))});let i={};s.addEventListener("eclipsedext",async({data:r})=>{let o=r.split("	"),c=Date.now();switch(o[0]){case"syn":{let l=o[1];i[l]=c,d()&&console.debug("[Eclipsed] Sending SYN/ACK"),s.sendComment(`eclipsed:synack	${l}`);break}case"ack":{let l=o[1],a=c-i[l];a<le?(s.#h=2,d()&&console.debug(`[Eclipsed] Connection ${s.#s} is streamed (${a}ms).`)):(s.#h=0,d()&&console.debug(`[Eclipsed] Connection ${s.#s} is chunked (${a}ms).`)),delete i[o[1]],s.#g=a;break}default:console.debug(`[Eclipsed] Unmatched extension: ${o}`)}})}},U,q,b,M,Q,de=(U=class extends EventTarget{constructor(t=15e3){super();v(this,M);v(this,q,void 0);v(this,b,{});E(this,"shutdownTimeout",15e3);this.shutdownTimeout=t}upgradeEventStream(t){let c;let n=this,s,i=t.headers.get("Accept");switch(i){case"text/event-stream":{s="eventSocket";break}case"application/grpc":{s="grpc";break}default:if(i.indexOf("application/grpc+")>=0)s="grpc";else return{untilRespond:Promise.resolve(),response:new Response("Bad request",{status:400,headers:A})}}if(s=="grpc"&&(t.method=="GET"||t.method=="get"))return{untilRespond:Promise.resolve(),response:new Response("Bad request",{status:400,headers:A})};let r,o;if(t.headers.has("Authorization")&&(o=t.headers.get("Authorization"),o.slice(0,7)=="Bearer "&&(o=o.slice(7))),!o&&t.headers.has("If-Match")&&(o=t.headers.get("If-Match"),o.slice(0,2)=="W/"&&(o=o.slice(2))),t.headers.has("Last-Event-ID")){o=t.headers.get("Last-Event-ID");let l=o.indexOf(".");l>0&&(o=o.slice(0,l))}if(o?r=W(c=n,M,Q).call(c,o):d()&&console.debug("[Eclipsed] The new connection has no ID."),r==Y)return{untilRespond:Promise.resolve(),response:new Response("Closed socket",{status:404,headers:A})};if(!r){let l=o||J(16);r=new j(n,l),w(n,b)[l]=r,r.addEventListener("newrx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("newtx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("connectrx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("connecttx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("connect",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("dangle",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("deadrx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("deadtx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("closerx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("closetx",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("close",a=>{n.dispatchEvent(new MessageEvent(a.type,{data:r}))}),r.addEventListener("shutdown",a=>{w(n,b)[l]=Y})}switch(t.method){case"GET":case"get":{return o&&r.useCustomExt(!0),{untilRespond:Promise.resolve(),response:r.newResponse()};break}case"POST":case"post":case"PUT":case"put":case"PATCH":case"patch":{switch(s){case"eventSocket":return{untilRespond:r.attachRequest(t),response:new Response("Client socket send complete",{status:200,headers:$})};case"grpc":return{untilRespond:Promise.resolve(),response:new Response("Client gRPC send complete",{status:200,headers:$})}}break}default:return{untilRespond:Promise.resolve(),response:new Response("Unknown method",{status:405,headers:A})}}}},q=new WeakMap,b=new WeakMap,M=new WeakSet,Q=function(t){return console.debug(`[Eclipsed] Does the socket pool have socket ID "${t}"? ${!!w(this,b)[t]}`),w(this,b)[t]},E(U,"EventSocket",j),U),Z=de;let h=function(e,t,n=!1){if(!t)if(n){if(e!=null)throw new TypeError("Value is not a null value")}else throw new TypeError("Type is not defined");if(e?.constructor){if(e.constructor!=t)throw new TypeError(`Value is not type ${t.name}`)}else if(!n)throw new TypeError("Value is not nullable")},ee=function(e,t=1,n,s=1,i){h(e,Uint8Array),h(n,Uint8Array),h(t,Number),h(s,Number);for(let r=0,o=0;r<e.length;r+=t,o+=s)i(e.subarray(r,r+t),n.subarray(o,o+s))},p=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],g={};p.forEach(function(e,t){g[e]=t});let x=function(e){return e>64&&e<9&&(e|=32),e},he=[{id:"korg87",win:[7,8],block:[function(e,t){for(let n=0;n<e.length;n++)t[n+1]=e[n]&127,t[0]|=e[n]>>7<<n},function(e,t){let n=e.length-1;for(let s=0;s<n;s++)t[s]=e[s+1]|(e[0]>>s&1)<<7}]},{id:"ov43",win:[3,4],block:[function(e,t){for(let n=0;n<e.length;n++)t[n+1]=e[n]&63,t[0]|=e[n]>>6<<(n<<1)},function(e,t){let n=e.length-1;for(let s=0;s<n;s++)t[s]=e[s+1]|(e[0]>>(s<<1)&3)<<6}]},{id:"ovm43",win:[3,4],block:[function(e,t){for(let n=0;n<e.length;n++)t[n+1]=p[e[n]&63],t[0]|=e[n]>>6<<(n<<1);t[0]=p[t[0]]},function(e,t){let n=e.length-1,s=g[e[0]];for(let i=0;i<n;i++)t[i]=g[e[i+1]]|(s>>(i<<1)&3)<<6}]},{id:"qb64",win:[3,4],block:[function(e,t){let n=0,s=e.length-1;for(let i=0;i<e.length;i++)n|=e[i]<<(i<<1),t[i]=p[n&63],n=n>>6,i==s&&(t[i+1]=p[n])},function(e,t){let n=0;for(let s=0;s<e.length;s++)n|=g[e[s]]<<[0,6,4,2][s],s&&(t[s-1]=n&255,n=n>>8)}]},{id:"qb32",win:[5,8],block:[function(e,t){let n=0,s=this.encodeLength(e.length),i=0,r=0;for(let o=0;o<e.length;o++)o<3?i|=e[o]<<(o<<3):r|=e[o]<<(o-3<<3);n=r*16777216+i;for(let o=0;o<s;o++)t[o]=p[n&31],n=Math.floor(n/32)},function(e,t){let n=0,s=this.decodeLength(e.length),i=0,r=0;for(let o=0;o<e.length;o++)o<4?i|=g[x(e[o])]<<o*5:o==4?(i|=(g[x(e[o])]&15)<<20,r|=g[x(e[o])]>>4):r|=g[x(e[o])]<<(o-5)*5+1;for(let o=0;o<s;o++)o<3?(t[o]=i&255,i=i>>8):(t[o]=r&255,r=r>>8)}]},{id:"qb16",win:[1,2],block:[function(e,t){t[0]=p[e[0]&15],t[1]=p[e[0]>>4]},function(e,t){t[0]=g[x(e[1]||0)]<<4|g[x(e[0])]}]},{id:"qb85",win:[4,5],block:[function(e,t){let n=0,s=this.encodeLength(e.length),i=0,r=0;e.forEach((o,c)=>{c>>1?i|=o<<((c&1)<<3):r|=o<<(c<<3)}),n=i*65536+r;for(let o=0;o<s;o++)t[o]=n%85+36,n=Math.floor(n/85)},function(e,t){let n=0,s=this.decodeLength(e.length);e.forEach((i,r)=>{n+=(i-36)*85**r});for(let i=0;i<s;i++)t[i]=n&255,n=n>>>8}]},{id:"qb128",win:[7,8],block:[function(e,t){let n=0,s=e.length-1;for(let i=0;i<e.length;i++)n|=e[i]<<i,t[i]=n&127,n=n>>7,i==s&&(t[i+1]=n)},function(e,t){let n=0;for(let s=0;s<e.length;s++)n|=e[s]<<[0,7,6,5,4,3,2,1][s],s&&(t[s-1]=n&255,n=n>>8)}]}],P=he;P.push({id:"qb36",win:[9,14],block:[function(e,t){let n=0n,s=BigInt(this.encodeLength(e.length));e.forEach((i,r)=>{n|=BigInt(i)<<(BigInt(r)<<3n)});for(let i=0n;i<s;i++)t[i]=Number(n%36n+32n),n/=36n},function(e,t){let n=0n,s=BigInt(this.decodeLength(e.length));e.forEach((i,r)=>{n+=(BigInt(i)-32n)*36n**BigInt(r)});for(let i=0n;i<s;i++)t[i]=Number(n&255n),n=n>>8n}]});P.push({id:"qb94",win:[9,11],block:[function(e,t){let n=0n,s=BigInt(this.encodeLength(e.length));e.forEach((i,r)=>{n|=BigInt(i)<<(BigInt(r)<<3n)});for(let i=0n;i<s;i++)t[i]=Number(n%94n+32n),n/=94n},function(e,t){let n=0n,s=BigInt(this.decodeLength(e.length));e.forEach((i,r)=>{n+=(BigInt(i)-32n)*94n**BigInt(r)});for(let i=0n;i<s;i++)t[i]=Number(n&255n),n=n>>8n}]});P.push({id:"qb95",win:[9,11],block:[function(e,t){let n=0n,s=BigInt(this.encodeLength(e.length));e.forEach((i,r)=>{n|=BigInt(i)<<(BigInt(r)<<3n)});for(let i=0n;i<s;i++)t[i]=Number(n%95n+32n),n/=95n},function(e,t){let n=0n,s=BigInt(this.decodeLength(e.length));e.forEach((i,r)=>{n+=(BigInt(i)-32n)*95n**BigInt(r)});for(let i=0n;i<s;i++)t[i]=Number(n&255n),n=n>>8n}]});let ue=P,ge=class{#t;#n;#e;#s;options={noInit:!1};get name(){return this.#n}get template(){return this.#t}encodeLength(e,t){return h(e,Number),this.#t?.len?this.#t?.len[0](e,t):Math.ceil(e*this.#s/this.#e)}decodeLength(e,t){return h(e,Number),this.#t?.len?this.#t?.len[1](e,t):Math.floor(e*this.#e/this.#s)}encodeBytes(e,t){if(h(e,Uint8Array),h(t,Uint8Array),t.length<this.encodeLength(e.length,e))throw new Error("Target isn't sufficient for encoding");!this.options.noInit&&t.fill(0);let n=this,s=JSON.parse(JSON.stringify(this.#t.init&&this.#t.init[0]||"null"));ee(e,this.#e,t,this.#s,function(i,r){n.#t?.block[0]?.call(n,i,r,s)})}decodeBytes(e,t){if(h(e,Uint8Array),h(t,Uint8Array),t.length<this.decodeLength(e.length,e))throw new Error("Target isn't sufficient for decoding");!this.options.noInit&&t.fill(0);let n=this,s=JSON.parse(JSON.stringify(this.#t.init&&this.#t.init[1]||"null"));ee(e,this.#s,t,this.#e,function(i,r){n.#t?.block[1]?.call(n,i,r,s)})}constructor(e,t){if(!e?.id)throw new Error("Invalid algorithm ID");if(e?.block.length!=2)throw new Error("Invalid codec");this.#n=e.name,this.#t=e,this.#e=e.win[0],this.#s=e.win[1],this.options=t||this.options}},pe=class{#t={};setAlgo(e){if(!e?.id)throw new Error("Invalid algorithm ID");this.#t[e.id]=e}delAlgo(e){this.#t[e]&&delete this.#t[e]}use(e,t){return new ge(this.#t[e],t)}constructor(e){h(e,Array,!0);let t=this;e?.forEach(function(n){t.setAlgo(n)})}},te=new pe(ue);self.debugMode=1;let B=te.use("ovm43",{noInit:!0}),fe=new TextEncoder,Ee=Deno.args[0]||"127.0.0.1",we=parseInt(Deno.args[1])||80,ve=parseInt(Deno.args[2])||8090,H=new Z,S={},_=async function({data:e}){let t=this;console.debug(`Message handler: ${t.id}.`);let n=S[t.id];if(n){let s=fe.encode(e),i=new Uint8Array(B.decodeLength(s.length));B.decodeBytes(s,i),await n.writer.write(i)}else t.msgBuffer=t.msgBuffer||[],t.msgBuffer.push(e)};H.addEventListener("connect",async({data:e})=>{let t=e;t.addEventListener("message",_),console.debug("[ConnMgr]  Establishing a new TCP connection..."),S[t.id]=S[t.id]||await Deno.connect({hostname:Ee,port:we});let n=S[t.id];n.reader=n.readable.getReader(),n.writer=n.writable.getWriter(),n.setNoDelay(!0),console.debug("[ConnMgr]  Adding handlers for TCP connection..."),(async()=>{let s=!0;for(;s;)try{let{value:i,done:r}=await n.reader.read();if(s=!r,i){let o=new Uint8Array(B.encodeLength(i.length));B.encodeBytes(i,o),t.sendDataRaw(o)}else t.close()}catch(i){console.debug(i),s=!1}})(),t.msgBuffer?.forEach(s=>{_.call(t,{data:s})})});H.addEventListener("dangle",({data:e})=>{let t=e;console.debug("[ConnMgr]  Disconnecting TCP..."),t.removeEventListener("message",_);let n=S[t.id];if(n){try{n.close()}catch(s){console.error(s)}delete S[t.id]}});Deno.serve({port:ve,hostname:"127.0.0.1"},async e=>{console.debug("[Web Root] Request received.");let{untilRespond:t,response:n}=H.upgradeEventStream(e);return console.debug("[Web Root] Stream upgraded."),await t,console.debug("[Web Root] Request responded."),n});
