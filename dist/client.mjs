var U=Object.defineProperty;var k=(r,t,e)=>t in r?U(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var u=(r,t,e)=>(k(r,typeof t!="symbol"?t+"":t,e),e),M=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var I=(r,t,e)=>(M(r,t,"read from private field"),e?e.call(r):t.get(r)),x=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)},T=(r,t,e,w)=>(M(r,t,"write to private field"),w?w.call(r,e):t.set(r,e),e);var L=["utf-8","utf-16","utf-16be"],g,y,p,C=(g=class extends EventTarget{constructor(t,e=0){super();x(this,y,void 0);x(this,p,void 0);if(e?.constructor!=Number||e<0||e>=L.length)throw new TypeError("Invalid split mode");if(e)throw new Error("UTF-16LE/BE currently not implemented");if(!t||t?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");T(this,y,t);let w=t.getReader();T(this,p,new TextDecoder(L[e],{fatal:!0}));let h=!0,n=!0,s;(async()=>{for(w.closed.then(()=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close")),n=!1}).catch(o=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),this.dispatchEvent(new Event("close")),n=!1});h&&n;)try{let o=await w.read();if(h=!o.done,h){let a=o.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:a})),a.constructor!=Uint8Array&&a.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:a}));else{let i=0,d=0,f=0,v=!1;for(let c=0;c<a.length;c++){switch(a[c]){case 10:{f==13?i++:(v=!0,d=c);break}case 13:{v=!0,d=c;break}default:v=!1}if(v){let l=a.subarray(i,d),E=l;s&&(E=new Uint8Array(s.length+l.length),E.set(s),E.set(l,s.length),s=void 0),this.dispatchEvent(new MessageEvent("raw",{data:E}));try{let P=I(this,p).decode(E);this.dispatchEvent(new MessageEvent("text",{data:P}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:E}))}i=c+1,v=!1}f=a[c]}if(!v)if(s){let c=a.subarray(i),l=new Uint8Array(s.length+c.length);l.set(s),l.set(c,s.length),s=l}else i<a.length&&(s=a.subarray(i))}}else s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close"))}catch(o){s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),this.dispatchEvent(new Event("close"))}})()}},y=new WeakMap,p=new WeakMap,u(g,"SPLIT_UTF_8",0),u(g,"SPLIT_UTF_16_LE",1),u(g,"SPLIT_UTF_16_BE",2),g),S=C;var R=class extends EventTarget{static sleep(r){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(r).addEventListener("abort",t):setTimeout(t,r)})}#e;#r;#t=!1;get finished(){return this.#t}finish(){this.#t=!0,this.#r&&this.#r()}wait(){if(!this.#t)return this.#e}constructor(){super(),this.#e=new Promise(r=>{this.#r=()=>{this.#t=!0,r()}})}},m=R;var b=3,A=3e3,_=200,D=class extends EventTarget{#e=0;#r="";#t=!1;#s;#n;#a=A;get readyState(){return this.#e}get url(){return this.#r}get withCredentials(){return this.#t}get lastEventId(){return this.#s}fetch;headers={};redirect="follow";referer;refererPolicy="no-referrer-when-downgrade";close(){this.#e=2,this.#n.abort()}constructor(r,t={}){super();let e=this;if(!r)throw new SyntaxError("Invalid URL");let w;try{w=new URL(r)}catch{throw new SyntaxError("Invalid URL")}e.#n=new AbortController,e.#r=r,e.#t=t.withCredentials||e.#t,e.headers=t.headers||e.headers,e.redirect=t.redirect||e.redirect,e.referer=t.referer||e.referer,e.refererPolicy=t.refererPolicy||e.refererPolicy,e.fetch=t.fetch||self.fetch,e.headers.Accept=e.headers.Accept||"text/event-stream",e.headers["Cache-Control"]=e.headers["Cache-Control"]||"no-store";let h=0;(async()=>{for(;e.#e<2&&h<3;)try{e.dispatchEvent(new Event("connecting")),e.#s?e.headers["Last-Event-ID"]=e.#s:e.headers["Last-Event-ID"]&&delete e.headers["Last-Event-ID"];let n=new m,s=await e.fetch(e.#r,{method:"GET",cache:"no-store",credentials:e.#t?"include":"omit",priority:"high",signal:e.#n.signal,headers:e.headers,redirect:e.redirect,referer:e.referer,refererPolicy:e.refererPolicy});if(s.status==200){e.dispatchEvent(new Event("open")),h=0;let o=new S(s.body,0,"utf-8"),a,i="";o.addEventListener("text",({data:d})=>{let f=d?.indexOf(":");if(!d?.trim()?.length)i&&(e.dispatchEvent(new MessageEvent(a||"message",{data:i,origin:e.#r,lastEventId:e.#s})),a=void 0,i="",e.#s=void 0);else if(d.codePointAt(0)!=58){if(f>-1){let v=d.slice(0,f),c=f+1;d.codePointAt(f+1)==32&&c++;let l=d.slice(c);switch(v){case"event":{a=l;break}case"data":{i.length&&(i+=`
`),i+=l;break}case"id":{d.indexOf("\0")==-1&&(e.#s=l);break}case"retry":{let E=parseInt(E);E&&E>=_&&(e.#a=E);break}default:}}}}),o.addEventListener("close",()=>{n.finish()}),await n.wait(),await m.sleep(Math.max(e.#a,A))}else e.dispatchEvent(new ErrorEvent("error",{message:s.statusText})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")),e.#e=2}catch(n){switch(n.name){case"AbortError":{e.#e=2,h=b,e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"NotAllowedError":{e.#e=2,h=b,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"TypeError":{n.message.indexOf("connection")>-1?(h++,h>b?(e.#e=2,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"))):await m.sleep(e.#a)):(e.#e=2,h=b,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")));break}}}})()}},z=D;export{z as default};
