"use strict";let S=["utf-8","utf-16","utf-16be"],M=class extends EventTarget{static SPLIT_UTF_8=0;static SPLIT_UTF_16_LE=1;static SPLIT_UTF_16_BE=2;#e;#t;constructor(r,t=0){if(super(),t?.constructor!=Number||t<0||t>=S.length)throw new TypeError("Invalid split mode");if(t)throw new Error("UTF-16LE/BE currently not implemented");if(!r||r?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");this.#e=r;let e=r.getReader();this.#t=new TextDecoder(S[t],{fatal:!0});let d=!0,i=!0,s;(async()=>{for(e.closed.then(()=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close")),i=!1}).catch(o=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),this.dispatchEvent(new Event("close")),i=!1});d&&i;)try{let o=await e.read();if(d=!o.done,d){let n=o.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:n})),n.constructor!=Uint8Array&&n.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:n}));else{let c=0,h=0,u=0,E=!1;for(let a=0;a<n.length;a++){switch(n[a]){case 10:{u==13?c++:(E=!0,h=a);break}case 13:{E=!0,h=a;break}default:E=!1}if(E){let l=n.subarray(c,h),f=l;s&&(f=new Uint8Array(s.length+l.length),f.set(s),f.set(l,s.length),s=void 0),this.dispatchEvent(new MessageEvent("raw",{data:f}));try{let m=this.#t.decode(f);this.dispatchEvent(new MessageEvent("text",{data:m}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:f}))}c=a+1,E=!1}u=n[a]}if(!E)if(s){let a=n.subarray(c),l=new Uint8Array(s.length+a.length);l.set(s),l.set(a,s.length),s=l}else c<n.length&&(s=n.subarray(c))}}else s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close"))}catch(o){s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),this.dispatchEvent(new Event("close"))}})()}},C=M;let O=class extends EventTarget{static sleep(r){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(r).addEventListener("abort",t):setTimeout(t,r)})}#e;#t;#r=!1;get finished(){return this.#r}finish(){this.#r=!0,this.#t&&this.#t()}wait(){if(!this.#r)return this.#e}constructor(){super(),this.#e=new Promise(r=>{this.#t=()=>{this.#r=!0,r()}})}},w=O;let P="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_",L=new Uint8Array(1),I=r=>{let t="";for(;r>0;)crypto.getRandomValues(L),t+=P[Math.floor(L[0]&63)],r--;return t},p=()=>!!self.debugMode,b=r=>r.replaceAll("\r",`
`).replaceAll(`\r
`,`
`).split(`
`);let y=3,D=3e3,A=200,N=2500;self.debugMode=1;let g=new TextEncoder,k=g.encode("data: "),R=class extends EventTarget{CONNECTING=0;OPEN=1;CLOSED=2;PROBING=1;TRUE=2;FALSE=0;#e=0;#t="";#r=!1;#s;#l;#d=D;#i=[];#h=1;#o=!1;#u=0;#c;get readyState(){return this.#e}get url(){return this.#t}get withCredentials(){return this.#r}get lastEventId(){return this.#s}fetch;headers={};redirect="follow";referer;refererPolicy="no-referrer-when-downgrade";acceptDuplex=!1;pingInterval=3e4;close(){this.#e=2,this.#l.abort()}constructor(r,t={}){super();let e=this;if(!r)throw new SyntaxError("Invalid URL");let d;try{d=new URL(r)}catch{throw new SyntaxError("Invalid URL")}e.#l=new AbortController,e.#t=r,e.#r=t.withCredentials||e.#r,e.headers=t.headers||e.headers,e.redirect=t.redirect||e.redirect,e.referer=t.referer||e.referer,e.refererPolicy=t.refererPolicy||e.refererPolicy,e.fetch=t.fetch||self.fetch,e.acceptDuplex=t.acceptDuplex||e.acceptDuplex,e.headers.Accept=e.headers.Accept||"text/event-stream",e.headers["Cache-Control"]=e.headers["Cache-Control"]||"no-store";let i=0;(async()=>{for(;e.#e<2&&i<3;)try{e.dispatchEvent(new Event("connecting"));let n=structuredClone(e.headers);e.#s?n["Last-Event-ID"]=e.#s:n["Last-Event-ID"]&&delete n["Last-Event-ID"],e.#o&&e.#c&&(n["If-Match"]=`W/${e.#c}`);let c=new w,h=await e.fetch(e.#t,{method:"GET",cache:"no-store",credentials:e.#r?"include":"omit",priority:"high",signal:e.#l.signal,headers:e.headers,redirect:e.redirect,referer:e.referer,refererPolicy:e.refererPolicy});if(h.status==200){e.#e=e.OPEN,e.dispatchEvent(new Event("open")),i=0,h.headers.has("ETag")&&(e.#c=h.headers.get("ETag")?.replace("W/",""));let u=new C(h.body,0,"utf-8"),E,a="";u.addEventListener("text",({data:l})=>{let f=l?.indexOf(":");if(!l?.trim()?.length)a&&(e.dispatchEvent(new MessageEvent(E||"message",{data:a,origin:e.#t,lastEventId:e.#s})),E=void 0,a="",e.#s=void 0);else if(l.codePointAt(0)==58)l.indexOf("eclipsed:")==1&&e.dispatchEvent(new MessageEvent("eclipsedext",{data:l.slice(10),origin:e.#t,lastEventId:e.#s}));else if(f>-1){let m=l.slice(0,f),x=f+1;l.codePointAt(f+1)==32&&x++;let T=l.slice(x);switch(m){case"event":{E=T;break}case"data":{a.length&&(a+=`
`),a+=T;break}case"id":{l.indexOf("\0")==-1&&(e.#s=T);break}case"retry":{let v=parseInt(v);v&&v>=A&&(e.#d=v);break}default:}}}),u.addEventListener("close",()=>{c.finish()}),await c.wait(),e.#e=e.CONNECTING,await w.sleep(Math.max(e.#d,D))}else e.dispatchEvent(new ErrorEvent("error",{message:h.statusText})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")),e.#e=2}catch(n){switch(n.name){case"AbortError":{e.#e=2,i=y,e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"NotAllowedError":{e.#e=2,i=y,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"TypeError":{n.message.indexOf("connection")>-1?(i++,i>y?(e.#e=2,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"))):await w.sleep(e.#d)):(e.#e=2,i=y,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")));break}}}})();let s={},o=async()=>{let n=I(16);s[n]=Date.now(),p()&&console.debug("[Eclipsed] Sending SYN"),await e.sendComment(`eclipsed:syn	${n}`)};e.addEventListener("eclipsedext",async({data:n})=>{let c=n.split("	"),h=Date.now();p()&&console.debug(`[Eclipsed] Extension: ${c}`);try{switch(c[0]){case"new":{e.#o=!0,await e.#n(),await o(),e.dispatchEvent(new Event("duplex"));break}case"synack":{let u=c[1],E=s[u];if(E){let a=h-E;a<N?(e.#h=2,p()&&console.debug(`[Eclipsed] Connection ${e.#c} is streamed (${a}ms).`)):(e.#h=0,p()&&console.debug(`[Eclipsed] Connection ${e.#c} is chunked (${a}ms).`)),delete s[u],e.#u=a,await e.sendComment(`eclipsed:ack	${u}`)}break}default:console.debug(`[Eclipsed] Unmatched extension: ${c}`)}}catch(u){console.debug(u)}}),(async()=>{for(;e.#e!=2;)await w.sleep(e.pingInterval),e.#e==1&&await o()})()}get duplexLatency(){return this.#u}get socketId(){let r=this;if(r.#o)return r.#c||r.#s.splice(".")[0]}async#n(r){let t=this;if(t.#e!=t.CLOSED&&(r||t.#i.length<1)){t.readyState==t.CONNECTING&&await w.sleep(t.#d);let e,d=!0,i=new w,s,o=new ReadableStream({start:h=>{s=h,i.finish()},cancel:h=>{if(i.finished){let u=t.#i.indexOf(e);u>=0&&t.#i.splice(u,1),t.#n()}else d=!1}}),n=structuredClone(t.headers);n["If-Match"]=`W/${t.socketId}`;let c=new Request(t.#t,{body:o,method:"POST",cache:"no-store",credentials:t.#r?"include":"omit",priority:"high",signal:t.#l.signal,headers:n,redirect:t.redirect,referer:t.referer,refererPolicy:t.refererPolicy});await i.wait(),t.fetch(c),e=[c,s],d&&(t.#i.push(e),p()&&console.debug("[Eclipsed] Created send socket."))}}#a(){let r=this;if(r.#i.length)return r.#i[0]}async sendEvent(r="message",t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");t||await e.#n(),errorWithControl(r),e.#a()[1].enqueue(g.encode(`event: ${r}
`))}async sendData(r,t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");t||await e.#n(),b(r).forEach(d=>{e.#a()[1].enqueue(g.encode(`data: ${d}
`))})}async sendDataRaw(r,t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");if(t||await e.#n(),!r?.byteLength||r.byteLength!=1)throw new TypeError("Only Uint8Array is accepted");let d=0,i=!1;for(let s=0;s<r.length;s++){let o=r[s];switch(o){case 10:case 13:i||(e.#a()[1].enqueue(k),e.#a()[1].enqueue(r.subarray(d,s)),i=!0),d=s+1;default:o<32&&(r[s]=32),i=!1}}i||(e.#a()[1].enqueue(k),e.#a()[1].enqueue(r.subarray(d,ptr)))}async sendComment(r,t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");t||await e.#n(),b(r).forEach(d=>{e.#a()[1].enqueue(g.encode(`:${d}
`))})}async sendFlush(r){let t=this;if(t.#e==t.CLOSED)throw new Error("Tried to send data through a closed socket");r||await t.#n(),t.#a()[1].enqueue(g.encode(`
`))}async send(r,t){let e=this;await e.#n(),t&&e.sendEvent(t,!0),e.sendData(r,!0),e.sendFlush(!0)}},j=R;export{j as default};
