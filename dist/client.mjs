"use strict";let b=["utf-8","utf-16","utf-16be"],P=class extends EventTarget{static SPLIT_UTF_8=0;static SPLIT_UTF_16_LE=1;static SPLIT_UTF_16_BE=2;#e;#t;constructor(r,t=0){if(super(),t?.constructor!=Number||t<0||t>=b.length)throw new TypeError("Invalid split mode");if(t)throw new Error("UTF-16LE/BE currently not implemented");if(!r||r?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");this.#e=r;let e=r.getReader();this.#t=new TextDecoder(b[t],{fatal:!0});let l=!0,a=!0,s;(async()=>{for(e.closed.then(()=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close")),a=!1}).catch(d=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:d.message,error:d})),this.dispatchEvent(new Event("close")),a=!1});l&&a;)try{let d=await e.read();if(l=!d.done,l){let n=d.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:n})),n.constructor!=Uint8Array&&n.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:n}));else{let o=0,h=0,E=0,u=!1;for(let i=0;i<n.length;i++){switch(n[i]){case 10:{E==13?o++:(u=!0,h=i);break}case 13:{u=!0,h=i;break}default:u=!1}if(u){let c=n.subarray(o,h),f=c;s&&(f=new Uint8Array(s.length+c.length),f.set(s),f.set(c,s.length),s=void 0),this.dispatchEvent(new MessageEvent("raw",{data:f}));try{let y=this.#t.decode(f);this.dispatchEvent(new MessageEvent("text",{data:y}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:f}))}o=i+1,u=!1}E=n[i]}if(!u)if(s){let i=n.subarray(o),c=new Uint8Array(s.length+i.length);c.set(s),c.set(i,s.length),s=c}else o<n.length&&(s=n.subarray(o))}}else s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close"))}catch(d){s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:d.message,error:d})),this.dispatchEvent(new Event("close"))}})()}},C=P;let O=class extends EventTarget{static sleep(r){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(r).addEventListener("abort",t):setTimeout(t,r)})}#e;#t;#r=!1;get finished(){return this.#r}finish(){this.#r=!0,this.#t&&this.#t()}wait(){if(!this.#r)return this.#e}constructor(){super(),this.#e=new Promise(r=>{this.#t=()=>{this.#r=!0,r()}})}},w=O;let A="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_",L=new Uint8Array(1),D=r=>{let t="";for(;r>0;)crypto.getRandomValues(L),t+=A[Math.floor(L[0]&63)],r--;return t},T=()=>!!self.debugMode,S=r=>r.replaceAll("\r",`
`).replaceAll(`\r
`,`
`).split(`
`);let v=3,I=3e3,N=200,R=2500;let p=new TextEncoder,k=p.encode("data: "),M=p.encode(`

`),q=class extends EventTarget{CONNECTING=0;OPEN=1;CLOSED=2;PROBING=1;TRUE=2;FALSE=0;#e=0;#t="";#r=!1;#n;#c;#l=I;#i=[];#h=1;#o=!1;#E=0;#d;get readyState(){return this.#e}get url(){return this.#t}get withCredentials(){return this.#r}get lastEventId(){return this.#n}fetch;headers={};redirect="follow";referer;refererPolicy="no-referrer-when-downgrade";acceptDuplex=!1;pingInterval=3e4;close(){this.#e=2,this.#c.abort()}constructor(r,t={}){super();let e=this;if(!r)throw new SyntaxError("Invalid URL");let l;try{l=new URL(r)}catch{throw new SyntaxError("Invalid URL")}e.#c=new AbortController,e.#t=r,e.#r=t.withCredentials||e.#r,e.headers=t.headers||e.headers,e.redirect=t.redirect||e.redirect,e.referer=t.referer||e.referer,e.refererPolicy=t.refererPolicy||e.refererPolicy,e.fetch=t.fetch||self.fetch,e.acceptDuplex=t.acceptDuplex||e.acceptDuplex,e.headers.Accept=e.headers.Accept||"text/event-stream",e.headers["Cache-Control"]=e.headers["Cache-Control"]||"no-store";let a=0;(async()=>{for(;e.#e<2&&a<3;)try{e.dispatchEvent(new Event("connecting"));let n=structuredClone(e.headers);e.#n?n["Last-Event-ID"]=e.#n:n["Last-Event-ID"]&&delete n["Last-Event-ID"],e.#o&&e.#d&&(n["If-Match"]=`W/${e.#d}`);let o=new w,h=await e.fetch(e.#t,{method:"GET",cache:"no-store",credentials:e.#r?"include":"omit",priority:"high",signal:e.#c.signal,headers:e.headers,redirect:e.redirect,referer:e.referer,refererPolicy:e.refererPolicy});if(h.status==200){e.#e=e.OPEN,e.dispatchEvent(new Event("open")),a=0,h.headers.has("ETag")&&(e.#d=h.headers.get("ETag")?.replace("W/",""));let E=new C(h.body,0,"utf-8"),u,i="";E.addEventListener("text",({data:c})=>{let f=c?.indexOf(":");if(!c?.trim()?.length)i&&(e.dispatchEvent(new MessageEvent(u||"message",{data:i,origin:e.#t,lastEventId:e.#n})),u=void 0,i="",e.#n=void 0);else if(c.codePointAt(0)==58)c.indexOf("eclipsed:")==1&&e.dispatchEvent(new MessageEvent("eclipsedext",{data:c.slice(10),origin:e.#t,lastEventId:e.#n}));else if(f>-1){let y=c.slice(0,f),x=f+1;c.codePointAt(f+1)==32&&x++;let m=c.slice(x);switch(y){case"event":{u=m;break}case"data":{i.length&&(i+=`
`),i+=m;break}case"id":{c.indexOf("\0")==-1&&(e.#n=m);break}case"retry":{let g=parseInt(g);g&&g>=N&&(e.#l=g);break}default:}}}),E.addEventListener("close",()=>{o.finish()}),await o.wait(),e.#e=e.CONNECTING,await w.sleep(Math.max(e.#l,I))}else e.dispatchEvent(new ErrorEvent("error",{message:h.statusText})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")),e.#e=2}catch(n){switch(n.name){case"AbortError":{e.#e=2,a=v,e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"NotAllowedError":{e.#e=2,a=v,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"TypeError":{n.message.indexOf("connection")>-1?(a++,a>v?(e.#e=2,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"))):await w.sleep(e.#l)):(e.#e=2,a=v,e.dispatchEvent(new ErrorEvent("error",{message:n.message,error:n})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")));break}}}})();let s={},d=async()=>{let n=D(16);s[n]=Date.now(),T()&&console.debug("[Eclipsed] Sending SYN"),await e.sendComment(`eclipsed:syn	${n}`)};e.addEventListener("eclipsedext",async({data:n})=>{let o=n.split("	"),h=Date.now();try{switch(o[0]){case"new":{e.#o=!0,await e.#a(),await d(),e.dispatchEvent(new Event("duplex"));break}case"synack":{let E=o[1],u=s[E];if(u){let i=h-u;i<R?e.#h=2:e.#h=0,delete s[E],e.#E=i,await e.sendComment(`eclipsed:ack	${E}`)}break}default:console.debug(`[Eclipsed] Unmatched extension: ${o}`)}}catch(E){console.debug(E)}}),(async()=>{for(;e.#e!=2;)await w.sleep(e.pingInterval),e.#e==1&&await d()})()}get duplexLatency(){return this.#E}get socketId(){let r=this;if(r.#o)return r.#d||r.#n.splice(".")[0]}async#a(r){let t=this;if(t.#e!=t.CLOSED&&(r||t.#i.length<1)){t.readyState==t.CONNECTING&&await w.sleep(t.#l);let e,l=!0,a=new w,s,d=new ReadableStream({start:h=>{s=h,a.finish()},cancel:h=>{if(a.finished){let E=t.#i.indexOf(e);E>=0&&t.#i.splice(E,1),t.#a()}else l=!1}}),n=structuredClone(t.headers);n["If-Match"]=`W/${t.socketId}`;let o=new Request(t.#t,{body:d,method:"POST",cache:"no-store",credentials:t.#r?"include":"omit",priority:"high",signal:t.#c.signal,headers:n,redirect:t.redirect,referer:t.referer,refererPolicy:t.refererPolicy});await a.wait(),(async()=>{try{await t.fetch(o)}catch(h){console.debug(h)}})(),e=[o,s],l&&(t.#i.push(e),T()&&console.debug("[Eclipsed] Created send socket."))}}#s(){let r=this;if(r.#i.length)return r.#i[0]}async sendEvent(r="message",t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");t||await e.#a(),errorWithControl(r),e.#s()[1].enqueue(p.encode(`event: ${r}
`))}async sendData(r,t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");t||await e.#a(),S(r).forEach(l=>{e.#s()[1].enqueue(p.encode(`data: ${l}
`))})}async sendDataRaw(r,t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");if(t||await e.#a(),!r?.BYTES_PER_ELEMENT||r.BYTES_PER_ELEMENT!=1)throw new TypeError("Only Uint8Array is accepted");let l=0,a=!1;for(let s=0;s<r.length;s++){let d=r[s];switch(d){case 10:case 13:a||(e.#s()[1].enqueue(k),e.#s()[1].enqueue(r.subarray(l,s)),e.#s()[1].enqueue(M),a=!0),l=s+1;default:d<32&&(r[s]=32),a=!1}}a||(e.#s()[1].enqueue(k),e.#s()[1].enqueue(r.subarray(l)),e.#s()[1].enqueue(M))}async sendComment(r,t){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");t||await e.#a(),S(r).forEach(l=>{e.#s()[1].enqueue(p.encode(`:${l}
`))})}async sendFlush(r){let t=this;if(t.#e==t.CLOSED)throw new Error("Tried to send data through a closed socket");r||await t.#a(),t.#s()[1].enqueue(p.encode(`
`))}async send(r,t){let e=this;await e.#a(),t&&e.sendEvent(t,!0),e.sendData(r,!0),e.sendFlush(!0)}},j=q;export{j as default};
