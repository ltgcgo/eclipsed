"use strict";let u=["utf-8","utf-16","utf-16be"],b=class extends EventTarget{static SPLIT_UTF_8=0;static SPLIT_UTF_16_LE=1;static SPLIT_UTF_16_BE=2;#e;#t;constructor(n,r=0){if(super(),r?.constructor!=Number||r<0||r>=u.length)throw new TypeError("Invalid split mode");if(r)throw new Error("UTF-16LE/BE currently not implemented");if(!n||n?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");this.#e=n;let e=n.getReader();this.#t=new TextDecoder(u[r],{fatal:!0});let f=!0,c=!0,t;(async()=>{for(e.closed.then(()=>{t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new Event("close")),c=!1}).catch(a=>{t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new ErrorEvent("error",{message:a.message,error:a})),this.dispatchEvent(new Event("close")),c=!1});f&&c;)try{let a=await e.read();if(f=!a.done,f){let s=a.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:s})),s.constructor!=Uint8Array&&s.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:s}));else{let o=0,d=0,l=0,h=!1;for(let i=0;i<s.length;i++){switch(s[i]){case 10:{l==13?o++:(h=!0,d=i);break}case 13:{h=!0,d=i;break}default:h=!1}if(h){let E=s.subarray(o,d),v=E;t&&(v=new Uint8Array(t.length+E.length),v.set(t),v.set(E,t.length),t=void 0),this.dispatchEvent(new MessageEvent("raw",{data:v}));try{let w=this.#t.decode(v);this.dispatchEvent(new MessageEvent("text",{data:w}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:v}))}o=i+1,h=!1}l=s[i]}if(!h)if(t){let i=s.subarray(o),E=new Uint8Array(t.length+i.length);E.set(t),E.set(i,t.length),t=E}else o<s.length&&(t=s.subarray(o))}}else t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new Event("close"))}catch(a){t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new ErrorEvent("error",{message:a.message,error:a})),this.dispatchEvent(new Event("close"))}})()}},y=b;let x=class extends EventTarget{static sleep(n){return new Promise(r=>{self.AbortSignal?AbortSignal.timeout(n).addEventListener("abort",r):setTimeout(r,n)})}#e;#t;#r=!1;get finished(){return this.#r}finish(){this.#r=!0,this.#t&&this.#t()}wait(){if(!this.#r)return this.#e}constructor(){super(),this.#e=new Promise(n=>{this.#t=()=>{this.#r=!0,n()}})}},g=x;let p=3,m=3e3,T=200,M=class extends EventTarget{#e=0;#t="";#r=!1;#s;#n;#a=m;get readyState(){return this.#e}get url(){return this.#t}get withCredentials(){return this.#r}get lastEventId(){return this.#s}fetch;headers={};redirect="follow";referer;refererPolicy="no-referrer-when-downgrade";close(){this.#e=2,this.#n.abort()}constructor(n,r={}){super();let e=this;if(!n)throw new SyntaxError("Invalid URL");let f;try{f=new URL(n)}catch{throw new SyntaxError("Invalid URL")}e.#n=new AbortController,e.#t=n,e.#r=r.withCredentials||e.#r,e.headers=r.headers||e.headers,e.redirect=r.redirect||e.redirect,e.referer=r.referer||e.referer,e.refererPolicy=r.refererPolicy||e.refererPolicy,e.fetch=r.fetch||self.fetch,e.headers.Accept=e.headers.Accept||"text/event-stream",e.headers["Cache-Control"]=e.headers["Cache-Control"]||"no-store";let c=0;(async()=>{for(;e.#e<2&&c<3;)try{e.dispatchEvent(new Event("connecting")),e.#s?e.headers["Last-Event-ID"]=e.#s:e.headers["Last-Event-ID"]&&delete e.headers["Last-Event-ID"];let t=new g,a=await e.fetch(e.#t,{method:"GET",cache:"no-store",credentials:e.#r?"include":"omit",priority:"high",signal:e.#n.signal,headers:e.headers,redirect:e.redirect,referer:e.referer,refererPolicy:e.refererPolicy});if(a.status==200){e.dispatchEvent(new Event("open")),c=0;let s=new y(a.body,0,"utf-8"),o,d="";s.addEventListener("text",({data:l})=>{let h=l?.indexOf(":");if(!l?.trim()?.length)d&&(e.dispatchEvent(new MessageEvent(o||"message",{data:d,origin:e.#t,lastEventId:e.#s})),o=void 0,d="",e.#s=void 0);else if(l.codePointAt(0)!=58){if(h>-1){let i=l.slice(0,h),E=h+1;l.codePointAt(h+1)==32&&E++;let v=l.slice(E);switch(i){case"event":{o=v;break}case"data":{d.length&&(d+=`
`),d+=v;break}case"id":{l.indexOf("\0")==-1&&(e.#s=v);break}case"retry":{let w=parseInt(w);w&&w>=T&&(e.#a=w);break}default:}}}}),s.addEventListener("close",()=>{t.finish()}),await t.wait(),await g.sleep(Math.max(e.#a,m))}else e.dispatchEvent(new ErrorEvent("error",{message:a.statusText})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")),e.#e=2}catch(t){switch(t.name){case"AbortError":{e.#e=2,c=p,e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"NotAllowedError":{e.#e=2,c=p,e.dispatchEvent(new ErrorEvent("error",{message:t.message,error:t})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"TypeError":{t.message.indexOf("connection")>-1?(c++,c>p?(e.#e=2,e.dispatchEvent(new ErrorEvent("error",{message:t.message,error:t})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"))):await g.sleep(e.#a)):(e.#e=2,c=p,e.dispatchEvent(new ErrorEvent("error",{message:t.message,error:t})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")));break}}}})()}},k=M;export{k as default};
//# sourceMappingURL=client.mjs.map
