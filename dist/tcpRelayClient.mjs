"use strict";let $=class extends EventTarget{static sleep(t){return new Promise(n=>{self.AbortSignal?AbortSignal.timeout(t).addEventListener("abort",n):setTimeout(n,t)})}#e;#t;#n=!1;get finished(){return this.#n}finish(){this.#n=!0,this.#t&&this.#t()}wait(){if(!this.#n)return this.#e}constructor(){super(),this.#e=new Promise(t=>{this.#t=()=>{this.#n=!0,t()}})}},w=$;let N=["utf-8","utf-16","utf-16be"],W=class extends EventTarget{static SPLIT_UTF_8=0;static SPLIT_UTF_16_LE=1;static SPLIT_UTF_16_BE=2;#e;#t;constructor(t,n=0){if(super(),n?.constructor!=Number||n<0||n>=N.length)throw new TypeError("Invalid split mode");if(n)throw new Error("UTF-16LE/BE currently not implemented");if(!t||t?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");this.#e=t;let e=t.getReader();this.#t=new TextDecoder(N[n],{fatal:!0});let i=!0,r=!0,s;(async()=>{for(e.closed.then(()=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close")),r=!1}).catch(a=>{s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:a.message,error:a})),this.dispatchEvent(new Event("close")),r=!1});i&&r;)try{let a=await e.read();if(i=!a.done,i){let o=a.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:o})),o.constructor!=Uint8Array&&o.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:o}));else{let h=0,d=0,f=0,u=!1;for(let l=0;l<o.length;l++){switch(o[l]){case 10:{f==13?h++:(u=!0,d=l);break}case 13:{u=!0,d=l;break}default:u=!1}if(u){let c=o.subarray(h,d),g=c;s&&(g=new Uint8Array(s.length+c.length),g.set(s),g.set(c,s.length),s=void 0),this.dispatchEvent(new MessageEvent("raw",{data:g}));try{let L=this.#t.decode(g);this.dispatchEvent(new MessageEvent("text",{data:L}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:g}))}h=l+1,u=!1}f=o[l]}if(!u)if(s){let l=o.subarray(h),c=new Uint8Array(s.length+l.length);c.set(s),c.set(l,s.length),s=c}else h<o.length&&(s=o.subarray(h))}}else s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new Event("close"))}catch(a){s&&(this.dispatchEvent(new MessageEvent("raw",{data:s})),s=void 0),this.dispatchEvent(new ErrorEvent("error",{message:a.message,error:a})),this.dispatchEvent(new Event("close"))}})()}},B=W;let G="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_",A=new Uint8Array(1),M=t=>{let n="";for(;t>0;)crypto.getRandomValues(A),n+=G[Math.floor(A[0]&63)],t--;return n},k=()=>!!self.debugMode,D=t=>t.replaceAll("\r",`
`).replaceAll(`\r
`,`
`).split(`
`);let I=3,O=3e3,J=200,V=2500;let y=new TextEncoder,U=y.encode("data: "),P=y.encode(`

`),Y=class extends EventTarget{CONNECTING=0;OPEN=1;CLOSED=2;PROBING=1;TRUE=2;FALSE=0;#e=0;#t="";#n=!1;#r;#o;#l=O;#a=[];#d=1;#h=!1;#f=0;#c;get readyState(){return this.#e}get url(){return this.#t}get withCredentials(){return this.#n}get lastEventId(){return this.#r}fetch;headers={};redirect="follow";referer;refererPolicy="no-referrer-when-downgrade";acceptDuplex=!1;pingInterval=3e4;close(){this.#e=2,this.#o.abort()}constructor(t,n={}){super();let e=this;if(!t)throw new SyntaxError("Invalid URL");let i;try{i=new URL(t)}catch{throw new SyntaxError("Invalid URL")}e.#o=new AbortController,e.#t=t,e.#n=n.withCredentials||e.#n,e.headers=n.headers||e.headers,e.redirect=n.redirect||e.redirect,e.referer=n.referer||e.referer,e.refererPolicy=n.refererPolicy||e.refererPolicy,e.fetch=n.fetch||self.fetch,e.acceptDuplex=n.acceptDuplex||e.acceptDuplex,e.headers.Accept=e.headers.Accept||"text/event-stream",e.headers["Cache-Control"]=e.headers["Cache-Control"]||"no-store";let r=0;(async()=>{for(;e.#e<2&&r<3;)try{e.dispatchEvent(new Event("connecting"));let o=structuredClone(e.headers);e.#r?o["Last-Event-ID"]=e.#r:o["Last-Event-ID"]&&delete o["Last-Event-ID"],e.#h&&e.#c&&(o["If-Match"]=`W/${e.#c}`);let h=new w,d=await e.fetch(e.#t,{method:"GET",cache:"no-store",credentials:e.#n?"include":"omit",priority:"high",signal:e.#o.signal,headers:e.headers,redirect:e.redirect,referer:e.referer,refererPolicy:e.refererPolicy});if(d.status==200){e.#e=e.OPEN,e.dispatchEvent(new Event("open")),r=0,d.headers.has("ETag")&&(e.#c=d.headers.get("ETag")?.replace("W/",""));let f=new B(d.body,0,"utf-8"),u,l="";f.addEventListener("text",({data:c})=>{let g=c?.indexOf(":");if(!c?.trim()?.length)l&&(e.dispatchEvent(new MessageEvent(u||"message",{data:l,origin:e.#t,lastEventId:e.#r})),u=void 0,l="",e.#r=void 0);else if(c.codePointAt(0)==58)c.indexOf("eclipsed:")==1&&e.dispatchEvent(new MessageEvent("eclipsedext",{data:c.slice(10),origin:e.#t,lastEventId:e.#r}));else if(g>-1){let L=c.slice(0,g),C=g+1;c.codePointAt(g+1)==32&&C++;let x=c.slice(C);switch(L){case"event":{u=x;break}case"data":{l.length&&(l+=`
`),l+=x;break}case"id":{c.indexOf("\0")==-1&&(e.#r=x);break}case"retry":{let b=parseInt(b);b&&b>=J&&(e.#l=b);break}default:}}}),f.addEventListener("close",()=>{h.finish()}),await h.wait(),e.#e=e.CONNECTING,await w.sleep(Math.max(e.#l,O))}else e.dispatchEvent(new ErrorEvent("error",{message:d.statusText})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")),e.#e=2}catch(o){switch(o.name){case"AbortError":{e.#e=2,r=I,e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"NotAllowedError":{e.#e=2,r=I,e.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"));break}case"TypeError":{o.message.indexOf("connection")>-1?(r++,r>I?(e.#e=2,e.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close"))):await w.sleep(e.#l)):(e.#e=2,r=I,e.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),e.dispatchEvent(new Event("disconnect")),e.dispatchEvent(new Event("close")));break}}}})();let s={},a=async()=>{let o=M(16);s[o]=Date.now(),k()&&console.debug("[Eclipsed] Sending SYN"),await e.sendComment(`eclipsed:syn	${o}`)};e.addEventListener("eclipsedext",async({data:o})=>{let h=o.split("	"),d=Date.now();try{switch(h[0]){case"new":{e.#h=!0,await e.#s(),await a(),e.dispatchEvent(new Event("duplex"));break}case"synack":{let f=h[1],u=s[f];if(u){let l=d-u;l<V?e.#d=2:e.#d=0,delete s[f],e.#f=l,await e.sendComment(`eclipsed:ack	${f}`)}break}default:console.debug(`[Eclipsed] Unmatched extension: ${h}`)}}catch(f){console.debug(f)}}),(async()=>{for(;e.#e!=2;)await w.sleep(e.pingInterval),e.#e==1&&await a()})()}get duplexLatency(){return this.#f}get socketId(){let t=this;if(t.#h)return t.#c||t.#r.splice(".")[0]}async#s(t){let n=this;if(n.#e!=n.CLOSED&&(t||n.#a.length<1)){n.readyState==n.CONNECTING&&await w.sleep(n.#l);let e,i=!0,r=new w,s,a=new ReadableStream({start:d=>{s=d,r.finish()},cancel:d=>{if(r.finished){let f=n.#a.indexOf(e);f>=0&&n.#a.splice(f,1),n.#s()}else i=!1}}),o=structuredClone(n.headers);o["If-Match"]=`W/${n.socketId}`;let h=new Request(n.#t,{body:a,method:"POST",cache:"no-store",credentials:n.#n?"include":"omit",priority:"high",signal:n.#o.signal,headers:o,redirect:n.redirect,referer:n.referer,refererPolicy:n.refererPolicy});await r.wait(),(async()=>{try{await n.fetch(h)}catch(d){console.debug(d)}})(),e=[h,s],i&&(n.#a.push(e),k()&&console.debug("[Eclipsed] Created send socket."))}}#i(){let t=this;if(t.#a.length)return t.#a[0]}async sendEvent(t="message",n){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");n||await e.#s(),errorWithControl(t),e.#i()[1].enqueue(y.encode(`event: ${t}
`))}async sendData(t,n){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");n||await e.#s(),D(t).forEach(i=>{e.#i()[1].enqueue(y.encode(`data: ${i}
`))})}async sendDataRaw(t,n){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");if(n||await e.#s(),!t?.BYTES_PER_ELEMENT||t.BYTES_PER_ELEMENT!=1)throw new TypeError("Only Uint8Array is accepted");let i=0,r=!1;for(let s=0;s<t.length;s++){let a=t[s];switch(a){case 10:case 13:r||(e.#i()[1].enqueue(U),e.#i()[1].enqueue(t.subarray(i,s)),e.#i()[1].enqueue(P),r=!0),i=s+1;default:a<32&&(t[s]=32),r=!1}}r||(e.#i()[1].enqueue(U),e.#i()[1].enqueue(t.subarray(i)),e.#i()[1].enqueue(P))}async sendComment(t,n){let e=this;if(e.#e==e.CLOSED)throw new Error("Tried to send data through a closed socket");n||await e.#s(),D(t).forEach(i=>{e.#i()[1].enqueue(y.encode(`:${i}
`))})}async sendFlush(t){let n=this;if(n.#e==n.CLOSED)throw new Error("Tried to send data through a closed socket");t||await n.#s(),n.#i()[1].enqueue(y.encode(`
`))}async send(t,n){let e=this;await e.#s(),n&&e.sendEvent(n,!0),e.sendData(t,!0),e.sendFlush(!0)}},q=Y;let E=function(t,n,e=!1){if(!n)if(e){if(t!=null)throw new TypeError("Value is not a null value")}else throw new TypeError("Type is not defined");if(t?.constructor){if(t.constructor!=n)throw new TypeError(`Value is not type ${n.name}`)}else if(!e)throw new TypeError("Value is not nullable")},R=function(t,n=1,e,i=1,r){E(t,Uint8Array),E(e,Uint8Array),E(n,Number),E(i,Number);for(let s=0,a=0;s<t.length;s+=n,a+=i)r(t.subarray(s,s+n),e.subarray(a,a+i))},v=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],p={};v.forEach(function(t,n){p[t]=n});let m=function(t){return t>64&&t<9&&(t|=32),t},j=[{id:"korg87",win:[7,8],block:[function(t,n){for(let e=0;e<t.length;e++)n[e+1]=t[e]&127,n[0]|=t[e]>>7<<e},function(t,n){let e=t.length-1;for(let i=0;i<e;i++)n[i]=t[i+1]|(t[0]>>i&1)<<7}]},{id:"ov43",win:[3,4],block:[function(t,n){for(let e=0;e<t.length;e++)n[e+1]=t[e]&63,n[0]|=t[e]>>6<<(e<<1)},function(t,n){let e=t.length-1;for(let i=0;i<e;i++)n[i]=t[i+1]|(t[0]>>(i<<1)&3)<<6}]},{id:"ovm43",win:[3,4],block:[function(t,n){for(let e=0;e<t.length;e++)n[e+1]=v[t[e]&63],n[0]|=t[e]>>6<<(e<<1);n[0]=v[n[0]]},function(t,n){let e=t.length-1,i=p[t[0]];for(let r=0;r<e;r++)n[r]=p[t[r+1]]|(i>>(r<<1)&3)<<6}]},{id:"qb64",win:[3,4],block:[function(t,n){let e=0,i=t.length-1;for(let r=0;r<t.length;r++)e|=t[r]<<(r<<1),n[r]=v[e&63],e=e>>6,r==i&&(n[r+1]=v[e])},function(t,n){let e=0;for(let i=0;i<t.length;i++)e|=p[t[i]]<<[0,6,4,2][i],i&&(n[i-1]=e&255,e=e>>8)}]},{id:"qb32",win:[5,8],block:[function(t,n){let e=0,i=this.encodeLength(t.length),r=0,s=0;for(let a=0;a<t.length;a++)a<3?r|=t[a]<<(a<<3):s|=t[a]<<(a-3<<3);e=s*16777216+r;for(let a=0;a<i;a++)n[a]=v[e&31],e=Math.floor(e/32)},function(t,n){let e=0,i=this.decodeLength(t.length),r=0,s=0;for(let a=0;a<t.length;a++)a<4?r|=p[m(t[a])]<<a*5:a==4?(r|=(p[m(t[a])]&15)<<20,s|=p[m(t[a])]>>4):s|=p[m(t[a])]<<(a-5)*5+1;for(let a=0;a<i;a++)a<3?(n[a]=r&255,r=r>>8):(n[a]=s&255,s=s>>8)}]},{id:"qb16",win:[1,2],block:[function(t,n){n[0]=v[t[0]&15],n[1]=v[t[0]>>4]},function(t,n){n[0]=p[m(t[1]||0)]<<4|p[m(t[0])]}]},{id:"qb85",win:[4,5],block:[function(t,n){let e=0,i=this.encodeLength(t.length),r=0,s=0;t.forEach((a,o)=>{o>>1?r|=a<<((o&1)<<3):s|=a<<(o<<3)}),e=r*65536+s;for(let a=0;a<i;a++)n[a]=e%85+36,e=Math.floor(e/85)},function(t,n){let e=0,i=this.decodeLength(t.length);t.forEach((r,s)=>{e+=(r-36)*85**s});for(let r=0;r<i;r++)n[r]=e&255,e=e>>>8}]},{id:"qb128",win:[7,8],block:[function(t,n){let e=0,i=t.length-1;for(let r=0;r<t.length;r++)e|=t[r]<<r,n[r]=e&127,e=e>>7,r==i&&(n[r+1]=e)},function(t,n){let e=0;for(let i=0;i<t.length;i++)e|=t[i]<<[0,7,6,5,4,3,2,1][i],i&&(n[i-1]=e&255,e=e>>8)}]}],T=j;T.push({id:"qb36",win:[9,14],block:[function(t,n){let e=0n,i=BigInt(this.encodeLength(t.length));t.forEach((r,s)=>{e|=BigInt(r)<<(BigInt(s)<<3n)});for(let r=0n;r<i;r++)n[r]=Number(e%36n+32n),e/=36n},function(t,n){let e=0n,i=BigInt(this.decodeLength(t.length));t.forEach((r,s)=>{e+=(BigInt(r)-32n)*36n**BigInt(s)});for(let r=0n;r<i;r++)n[r]=Number(e&255n),e=e>>8n}]});T.push({id:"qb94",win:[9,11],block:[function(t,n){let e=0n,i=BigInt(this.encodeLength(t.length));t.forEach((r,s)=>{e|=BigInt(r)<<(BigInt(s)<<3n)});for(let r=0n;r<i;r++)n[r]=Number(e%94n+32n),e/=94n},function(t,n){let e=0n,i=BigInt(this.decodeLength(t.length));t.forEach((r,s)=>{e+=(BigInt(r)-32n)*94n**BigInt(s)});for(let r=0n;r<i;r++)n[r]=Number(e&255n),e=e>>8n}]});T.push({id:"qb95",win:[9,11],block:[function(t,n){let e=0n,i=BigInt(this.encodeLength(t.length));t.forEach((r,s)=>{e|=BigInt(r)<<(BigInt(s)<<3n)});for(let r=0n;r<i;r++)n[r]=Number(e%95n+32n),e/=95n},function(t,n){let e=0n,i=BigInt(this.decodeLength(t.length));t.forEach((r,s)=>{e+=(BigInt(r)-32n)*95n**BigInt(s)});for(let r=0n;r<i;r++)n[r]=Number(e&255n),e=e>>8n}]});let H=T,z=class{#e;#t;#n;#r;options={noInit:!1};get name(){return this.#t}get template(){return this.#e}encodeLength(t,n){return E(t,Number),this.#e?.len?this.#e?.len[0](t,n):Math.ceil(t*this.#r/this.#n)}decodeLength(t,n){return E(t,Number),this.#e?.len?this.#e?.len[1](t,n):Math.floor(t*this.#n/this.#r)}encodeBytes(t,n){if(E(t,Uint8Array),E(n,Uint8Array),n.length<this.encodeLength(t.length,t))throw new Error("Target isn't sufficient for encoding");!this.options.noInit&&n.fill(0);let e=this,i=JSON.parse(JSON.stringify(this.#e.init&&this.#e.init[0]||"null"));R(t,this.#n,n,this.#r,function(r,s){e.#e?.block[0]?.call(e,r,s,i)})}decodeBytes(t,n){if(E(t,Uint8Array),E(n,Uint8Array),n.length<this.decodeLength(t.length,t))throw new Error("Target isn't sufficient for decoding");!this.options.noInit&&n.fill(0);let e=this,i=JSON.parse(JSON.stringify(this.#e.init&&this.#e.init[1]||"null"));R(t,this.#r,n,this.#n,function(r,s){e.#e?.block[1]?.call(e,r,s,i)})}constructor(t,n){if(!t?.id)throw new Error("Invalid algorithm ID");if(t?.block.length!=2)throw new Error("Invalid codec");this.#t=t.name,this.#e=t,this.#n=t.win[0],this.#r=t.win[1],this.options=n||this.options}},K=class{#e={};setAlgo(t){if(!t?.id)throw new Error("Invalid algorithm ID");this.#e[t.id]=t}delAlgo(t){this.#e[t]&&delete this.#e[t]}use(t,n){return new z(this.#e[t],n)}constructor(t){E(t,Array,!0);let n=this;t?.forEach(function(e){n.setAlgo(e)})}},_=new K(H);self.debugMode=1;let S=_.use("ovm43",{noInit:!0}),Q=new TextEncoder,F=Deno.args[0],X=parseInt(Deno.args[1])||8091;F||(console.error("Invalid SSE URL."),Deno.exit(0));let Z=Deno.listen({hostname:"127.0.0.1",port:X});for await(let t of Z){console.debug("Connection accepted."),console.debug("R/W defined.");let n=new w,e=new q(F);e.addEventListener("duplex",()=>{t.reader=t.readable.getReader(),t.writer=t.writable.getWriter(),n.finish()}),e.addEventListener("message",async({data:i})=>{let r=Q.encode(i),s=new Uint8Array(S.decodeLength(r.length));S.decodeBytes(r,s),await t.writer.write(s)}),await n.wait(),(async()=>{let i=!0;for(;i;)try{console.debug("Waiting to read...");let{value:r,done:s}=await t.reader.read();if(console.debug("Incoming data read."),i=!s,r){let a=new Uint8Array(S.encodeLength(r.length));S.encodeBytes(r,a),await e.sendDataRaw(a)}else s&&(await w.sleep(160),e.close())}catch(r){console.debug(r),i=!1}})()}
