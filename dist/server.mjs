"use strict";let _=Object.defineProperty;let B=(r,e,s)=>e in r?_(r,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[e]=s;let E=(r,e,s)=>(B(r,typeof e!="symbol"?e+"":e,s),s),S=(r,e,s)=>{if(!e.has(r))throw TypeError("Cannot "+s)};let f=(r,e,s)=>(S(r,e,"read from private field"),s?s.call(r):e.get(r)),c=(r,e,s)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,s)},C=(r,e,s,a)=>(S(r,e,"write to private field"),a?a.call(r,s):e.set(r,s),s);let M=(r,e,s)=>(S(r,e,"access private method"),s);let U=["utf-8","utf-16","utf-16be"],w,m,g,z=(w=class extends EventTarget{constructor(e,s=0){super();c(this,m,void 0);c(this,g,void 0);if(s?.constructor!=Number||s<0||s>=U.length)throw new TypeError("Invalid split mode");if(s)throw new Error("UTF-16LE/BE currently not implemented");if(!e||e?.constructor!=ReadableStream)throw new TypeError("Not a readable stream");C(this,m,e);let a=e.getReader();C(this,g,new TextDecoder(U[s],{fatal:!0}));let d=!0,l=!0,t;(async()=>{for(a.closed.then(()=>{t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new Event("close")),l=!1}).catch(o=>{t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),this.dispatchEvent(new Event("close")),l=!1});d&&l;)try{let o=await a.read();if(d=!o.done,d){let n=o.value;if(this.dispatchEvent(new MessageEvent("chunk",{data:n})),n.constructor!=Uint8Array&&n.constructor!=Uint8ClampedArray)this.dispatchEvent(new MessageEvent("fail",{data:n}));else{let p=0,P=0,I=0,u=!1;for(let i=0;i<n.length;i++){switch(n[i]){case 10:{I==13?p++:(u=!0,P=i);break}case 13:{u=!0,P=i;break}default:u=!1}if(u){let h=n.subarray(p,P),v=h;t&&(v=new Uint8Array(t.length+h.length),v.set(t),v.set(h,t.length),t=void 0),this.dispatchEvent(new MessageEvent("raw",{data:v}));try{let H=f(this,g).decode(v);this.dispatchEvent(new MessageEvent("text",{data:H}))}catch{this.dispatchEvent(new MessageEvent("fail",{data:v}))}p=i+1,u=!1}I=n[i]}if(!u)if(t){let i=n.subarray(p),h=new Uint8Array(t.length+i.length);h.set(t),h.set(i,t.length),t=h}else p<n.length&&(t=n.subarray(p))}}else t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new Event("close"))}catch(o){t&&(this.dispatchEvent(new MessageEvent("raw",{data:t})),t=void 0),this.dispatchEvent(new ErrorEvent("error",{message:o.message,error:o})),this.dispatchEvent(new Event("close"))}})()}},m=new WeakMap,g=new WeakMap,E(w,"SPLIT_UTF_8",0),E(w,"SPLIT_UTF_16_LE",1),E(w,"SPLIT_UTF_16_BE",2),w);let W=new Uint8Array(1);let k={Server:"Eclipsed","Content-Type":"text/plain","Cache-Control":"no-cache, no-store","Access-Control-Allow-Methods":"GET, POST, PUT, PATCH, OPTIONS","Access-Control-Allow-Origin":"*"},x={Server:"Eclipsed","Content-Type":"text/event-stream","Cache-Control":"no-cache, no-store",Vary:"Authorization, If-Match, Last-Event-ID","Access-Control-Allow-Headers":"Authorization, Accept, Cache-Control, If-Match, Last-Event-ID","Access-Control-Allow-Methods":"GET, POST, PUT, PATCH, OPTIONS","Access-Control-Allow-Origin":"*"},$=new TextEncoder,O=class extends EventTarget{#e;constructor(r){super();let e=this;if(!r)throw new Error("Invalid event socket root");e.#e=r}},y,b,T,A,L,R,D=(y=class extends EventTarget{constructor(){super();c(this,A);c(this,b,void 0);c(this,T,{});c(this,R,void 0)}upgradeEventStream(e){let o;let s=this,a,d=e.headers.get("Accept");switch(d){case"text/event-stream":{a="eventSocket";break}case"application/grpc":{a="grpc";break}default:if(d.indexOf("application/grpc+")>=0)a="grpc";else return{untilRespond:Promise.resolve(),response:new Response("Bad request",{status:400,headers:k})}}if(a=="grpc"&&(e.method=="GET"||e.method=="get"))return{untilRespond:Promise.resolve(),response:new Response("Bad request",{status:400,headers:k})};let l,t;if(e.headers.has("Authorization")?(t=e.headers.get("Authorization"),t.slice(0,7)!="Bearer "&&(t=void 0)):e.headers.has("If-Match")&&(t=e.headers.get("If-Match"),t.slice(0,2)=="W/"&&(t=t.slice(2))),e.headers.has("Last-Event-ID")){t=e.headers.get("Last-Event-ID");let n=t.indexOf(".");n>0&&(t=t.slice(0,n))}switch(t&&(l=M(o=s,A,L).call(o,t)),l||(l=new O(s)),e.method){case"GET":case"get":return{untilRespond:Promise.resolve(),response:new Response("Success",{status:200,headers:x})};case"POST":case"post":case"PUT":case"put":case"PATCH":case"patch":{switch(a){case"eventSocket":return{untilRespond:Promise.resolve(),response:new Response("Client socket send complete",{status:200,headers:x})};case"grpc":return{untilRespond:Promise.resolve(),response:new Response("Client gRPC send complete",{status:200,headers:x})}}break}default:return{untilRespond:Promise.resolve(),response:new Response("Unknown method",{status:405,headers:k})}}}},b=new WeakMap,T=new WeakMap,A=new WeakSet,L=function(e){return f(this,T)[e]},R=new WeakMap,E(y,"EventSocket",O),y),q=D;export{q as default};
